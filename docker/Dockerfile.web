# SolidityGuard Web — FastAPI backend + React frontend
# Usage:
#   docker build -f docker/Dockerfile.web -t solidityguard-web .
#   docker run -p 8000:8000 solidityguard-web
#   Open http://localhost:8000

# Stage 1: Build frontend
FROM node:22-slim AS frontend-build

WORKDIR /frontend
COPY apps/web/frontend/package.json ./
RUN npm install
COPY apps/web/frontend/ ./
RUN npm run build

# Stage 2: Python backend + serve built frontend
FROM python:3.12-slim

LABEL maintainer="Alt Research Ltd."
LABEL description="SolidityGuard Web — audit dashboard with real-time progress"
LABEL version="1.1.1"

RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    git \
    libpango-1.0-0 \
    libpangocairo-1.0-0 \
    libgdk-pixbuf-2.0-0 \
    libffi-dev \
    libcairo2 \
    && rm -rf /var/lib/apt/lists/*

# Install Foundry (optional — used for forge verify, not required for web UI)
RUN curl -L https://foundry.paradigm.xyz | bash && \
    /root/.foundry/bin/foundryup || true
ENV PATH="/root/.foundry/bin:${PATH}"

# Install security tools (optional — heavy deps, may fail in constrained environments)
RUN pip install --no-cache-dir slither-analyzer || true
RUN pip install --no-cache-dir mythril || true

# Install PDF generation (required — must succeed, separated to avoid cache issues)
RUN pip install --no-cache-dir weasyprint markdown && \
    python3 -c "import weasyprint; print('weasyprint OK')"

WORKDIR /app

# Copy scanner scripts
COPY .claude/skills/solidity-guard/scripts/ /app/scripts/

# Copy and install backend
COPY apps/web/backend/ /app/backend/
RUN pip install --no-cache-dir /app/backend/

# Copy built frontend
COPY --from=frontend-build /frontend/dist /app/static

# Copy knowledge base
COPY knowledge-base/ /app/knowledge-base/

EXPOSE 8000

CMD ["uvicorn", "solidityguard_api.main:app", "--host", "0.0.0.0", "--port", "8000"]
